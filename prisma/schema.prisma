generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model RuleBook {
  id          String    @id @default(cuid())
  title       String
  description String?
  version     String    @default("1.0.0")
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String
  chapters    Chapter[]
  creator     User      @relation(fields: [createdBy], references: [id])

  @@map("rule_books")
}

model Chapter {
  id          String   @id @default(cuid())
  bookId      String
  number      Float
  title       String
  subtitle    String?
  section     String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  htmlContent String?
  book        RuleBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  rules       Rule[]

  @@unique([bookId, number])
  @@map("chapters")
}

model Rule {
  id            String         @id @default(cuid())
  chapterId     String
  number        String
  title         String
  content       String
  order         Int            @default(0)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  contentBlocks ContentBlock[]
  images        RuleImage[]
  links         RuleLink[]
  chapter       Chapter        @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([chapterId, number])
  @@map("rules")
}

model ContentBlock {
  id        String        @id @default(cuid())
  ruleId    String?
  manualId  String?
  circularId String?
  type      ContentType
  content   String
  metadata  Json?         // For storing additional formatting data (table structure, image info, etc.)
  order     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  rule      Rule?     @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  manual    Manual?   @relation(fields: [manualId], references: [id], onDelete: Cascade)
  circular  Circular? @relation(fields: [circularId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([manualId])
  @@index([circularId])
  @@map("content_blocks")
}

model RuleLink {
  id           String   @id @default(cuid())
  ruleId       String
  linkType     LinkType
  title        String
  url          String?
  targetRuleId String?
  description  String?
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  rule         Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@map("rule_links")
}

model Image {
  id           String      @id @default(cuid())
  filename     String
  originalName String
  url          String
  size         Int
  mimeType     String
  uploadedBy   String
  createdAt    DateTime    @default(now())
  uploader     User        @relation(fields: [uploadedBy], references: [id])
  ruleImages   RuleImage[]

  @@map("images")
}

model RuleImage {
  id        String   @id @default(cuid())
  ruleId    String
  imageId   String
  caption   String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  rule      Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@unique([ruleId, imageId])
  @@map("rule_images")
}

model Manual {
  id          String   @id @default(cuid())
  code        String   @unique
  title       String
  description String?
  version     String?
  pdfUrl      String?
  pdfFileName String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  contentBlocks ContentBlock[]

  @@map("manuals")
}

model Circular {
  id          String    @id @default(cuid())
  code        String    @unique
  title       String
  description String?
  number      String?
  date        DateTime?
  pdfUrl      String?
  pdfFileName String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  contentBlocks ContentBlock[]

  @@map("circulars")
}

model ChangeLog {
  id            String         @id @default(cuid())
  entityType    EntityType
  entityId      String
  action        ChangeAction
  changes       Json
  reason        String?
  supportingDoc String?
  userId        String
  createdAt     DateTime       @default(now())
  user          User           @relation(fields: [userId], references: [id])
  notifications Notification[]

  @@index([entityId])
  @@index([entityType])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("change_logs")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  role          UserRole       @default(USER)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  changeLogs    ChangeLog[]
  images        Image[]
  notifications Notification[]
  books         RuleBook[]

  @@map("users")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  title       String
  message     String
  type        NotificationType @default(INFO)
  isRead      Boolean          @default(false)
  entityType  EntityType?
  entityId    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  changelogId String?
  changelog   ChangeLog?       @relation(fields: [changelogId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([entityType])
  @@index([userId, isRead])
  @@map("notifications")
}

enum UserRole {
  ADMIN
  EDITOR
  USER
}

enum ContentType {
  TEXT
  HEADING
  IMAGE
  TABLE
  LIST
  QUOTE
  CODE
  LINK
  PARAGRAPH
  REFERENCE
}

enum LinkType {
  INTERNAL_RULE
  MANUAL
  CIRCULAR
  EXTERNAL_URL
  DOCUMENT
}


enum EntityType {
  RULE_BOOK
  CHAPTER
  RULE
  CONTENT_BLOCK
  RULE_LINK
  MANUAL
  CIRCULAR
}

enum ChangeAction {
  CREATE
  UPDATE
  DELETE
  ARCHIVE
  RESTORE
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  CHANGE
}

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

const htmlContent = `Pilot shall also advise the Guard through walkie-talkie of all the documents handed over to him with regard to the working of trains. The information received should be recorded by the Guard in the rough journal and combined train report.</p>
        </div>
    </section>

    <!-- Rule 4.02 -->
    <section id="4.02">
        <div>
            <p>No passenger train or mixed train shall be despatched from a station before the advertised time.</p>
        </div>
    </section>

    <!-- Rule 4.03 -->
    <section id="4.03">
        <div>
            <p>Before a train starts from a terminal or crew-changing station, the Guard shall set his watch by the station clock or the clock at the authorised place of reporting for duty and communicate the time to the Loco Pilot who shall set his watch accordingly.</p>
        </div>
    </section>

    <!-- Rule 4.04 -->
    <section id="4.04">
        <div>
            <p>Every Guard, Loco Pilot, Assistant Loco Pilot shall be in attendance for duty at such place and at such time as may be prescribed by special instructions.</p>
            <p>S.R.4.04(i) Guards and Assistant Guards of Express, Mail and Passenger trains shall appear on duty thirty minutes before the booked departure of the trains, Guards and Assistant Guards of road vans, Mixed, Goods and Departmental trains, also shall appear on duty thirty minutes before the booked or notified departure of the trains.</p>
            <p>S.R.4.04(ii) When Guards and Brakesmen report for or break off duty, they shall sign in the Guards "On" and "Off" duty Register entering the time.</p>
        </div>
    </section>

    <!-- Rule 4.05 -->
    <section id="4.05">
        <div>
            <p>The Loco Pilot shall take his train along the proper running line.</p>
            <p>S.R.4.05(i) Except as provided for in the Station Working Rules, the berthing of a train on a non-running line for crossing purposes is prohibited. However, light engines may, after being received into the station on a running line in the usual manner, be shunted on to and berthed on a non-running line whenever necessary, without any special instructions. When a light engine is so berthed on a non-running line, it shall not be reckoned as a crossing train for the purpose of computing the number of trains to be crossed at the station.</p>
            <p>S.R.4.05(ii)(a) The Goods Home signal shall not be taken 'Off' for a train carrying passengers. If so, the Loco Pilot of a passenger train shall stop short of the Goods Home signal, inform the Guard and send his Assistant Loco Pilot to the station to inform the Station Master. The Station Master shall put back the Goods Home signal to 'On' and take 'Off' the Passenger Home signal and give a memo to the Loco Pilot (countersigned by the Guard) authorizing the Loco Pilot to enter the station observing the 'Off' aspect of the Passenger Home signal. In such cases, the Guard shall send a special report to the Divisional Operations Manager along with the Combined Train Report.</p>
            <p>S.R.4.05(ii)(b) A goods train may be received either into the Coaching or Goods yard by taking 'Off' relevant signals according to operational convenience.</p>
        </div>
    </section>

    <!-- Rule 4.06 -->
    <section id="4.06">
        <div>
            <p>(1) On a double line, every train shall run on the left hand line unless otherwise prescribed by special instructions.</p>
            <p>(2) If there are two or more parallel lines, the direction in which trains are to run on each line shall be prescribed by special instructions.</p>
            <p>S.R.4.06(i) The Up and Down direction of traffic on the various sections are given in the Working Time Table.</p>
        </div>
    </section>

    <!-- Rule 4.07 -->
    <section id="4.07">
        <div>
            <p>(1) A copy of the Working Time Table for the time being in force shall be supplied to each station, Guard, Loco Pilot, Inspector of Way or Works, and any other railway servant requiring the use of the Working Time Table during the course of his duties.</p>
            <p>(2) A copy of the Working Time Table shall, on issue, be supplied to the Commissioner of Railway Safety.</p>
            <p>(3) A copy of the Schedule of Standard Dimensions for the time being in force shall be supplied to each Inspector of Way or Works and Train Examiner.</p>
        </div>
    </section>

    <h3>B. Speed of Trains</h3>

    <!-- Rule 4.08 -->
    <section id="4.08">
        <div>
            <p>(1) (a) Every train shall be run on each section of the railway within the limits of speed sanctioned for that section by special instructions.</p>
            <p>(Ref:- Railway Board's letter No. 2022/Safety(A&R)/19/20 dated 27.07.22) (Correction Memo 03/2022 dated 12.08.2022)</p>
            <p>(b) The sectional speed sanctioned and permanent speed restrictions shall be shown in the Working Time Table.</p>
            <p>(c) The Loco Pilot shall observe the sanctioned sectional speed except when either one speedometer in case of electric loco or two speedometers in case of other locomotives are defective. In such cases of defective speedometers both the maximum permissible speed and booked speed of coaching trains shall be reduced by ten per cent from the speed otherwise permissible.</p>
            <p>(2) The Loco Pilot shall:- (a) regulate and control the running of the train according to the Working Time Table, so as to avoid either excessive speed or loss of time, and (b) not make up between any two stations more time than is allowed in this behalf in the Working Time Table, and shall also observe all speed restrictions.</p>
            <p>(3) When it is necessary to indicate to the Loco Pilot where trains are to run at a restricted speed or where trains have to come to a stop due to the line being under repairs or due to any other obstruction, action shall be taken as specified in Rule 15.09.</p>
            <p>S.R. 4.08(i) No locomotive shall be turned out from the shed with deficient or defective speedometer. In case, the speedometer becomes defective enroute, the Loco Pilot shall work the train at speed 10% less than the permissible speed by estimating the speed with the help of his watch, kilometre posts and inter-station running time given in the Working Time Table.</p>
            <p>S.R. 4.08(ii) The Maximum permissible speed of Goods trains and Mixed Trains in Broad Gauge is 75 kmph except in case of trains with rolling stock where a higher speed is permitted as indicated in the Working Time Table.</p>
            <p>(Correction Memo No.04/2015 dated 28.08.15)</p>
        </div>
    </section>

    <!-- Rule 4.09 -->
    <section id="4.09">
        <div>
            <p>(1) Whenever, in consequence of the line being under repair or for any other reason, special precautions are necessary, a Caution Order detailing the kilometres between which such precautions are necessary, the reasons for taking such precautions, and the speed at which a train shall travel, shall be handed over to the Loco Pilot at the stopping station immediately short of the place where such precautions are necessary, or at such other stations, and in such manner, as prescribed under special instructions.</p>
            <p>(2) Sub-rule (1) does not apply in the case of long continued repairs when fixed signals are provided at an adequate distance short of such place and have been notified to the running staff concerned.</p>
            <p>(3) The Caution Order referred to in sub-rule (1) shall be on white paper, with green font and be made out and signed in full.</p>

            <h4>S.R.4.09 (i) ISSUE OF CAUTION ORDERS</h4>
            <table border="1">
                <tr>
                    <th>#</th>
                    <th>Circumstance</th>
                    <th>Particulars of caution</th>
                    <th>Reference</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>When a token of the Block section is extracted in connection with the work involving disconnection of points at the outlying siding.</td>
                    <td>Token handed over to Signal & Telecommunication department official for disconnection of points at the outlying siding. 'Observe special caution as necessary and lookout for hand signals at site'.</td>
                    <td>Para No. 4.15 (xxvi) of BWM Part 1</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>Whenever Loco Pilots report about slack or rough running or heavy lurch or any abnormal condition in the track over which his train has passed.</td>
                    <td>Loco Pilot's message shall be repeated and the clause, 'Observe Special Caution, reduce speed as necessary and do not in any case, exceed a speed of 10 KMPH and stop dead sufficiently short of the affected portion of the track before taking necessary action' to be added.</td>
                    <td>-</td>
                </tr>
            </table>
        </div>
    </section>`;

function parseRules(html) {
  const rules = [];
  const sections = html.match(/<section id="([^"]+)">(.*?)<\/section>/gs) || [];
  
  sections.forEach((section, index) => {
    const idMatch = section.match(/id="([^"]+)"/);
    const contentMatch = section.match(/<div>(.*?)<\/div>/s);
    
    if (idMatch && contentMatch) {
      const ruleNumber = idMatch[1];
      const content = contentMatch[1].trim();
      const title = extractTitle(content);
      
      rules.push({
        number: ruleNumber,
        title: title,
        content: content,
        order: index + 1
      });
    }
  });
  
  return rules;
}

function extractTitle(content) {
  const firstP = content.match(/<p>(.*?)<\/p>/s);
  if (firstP) {
    const text = firstP[1].replace(/<[^>]*>/g, '').trim();
    return text.length > 100 ? text.substring(0, 100) + '...' : text;
  }
  return 'Railway Rule';
}

async function updateRules() {
  try {
    console.log('Parsing rules from HTML content...');
    const rules = parseRules(htmlContent);
    
    // Get chapter 4
    const chapter = await prisma.chapter.findFirst({
      where: { number: 4 }
    });
    
    if (!chapter) {
      console.error('Chapter 4 not found. Run update-chapter4.js first.');
      return;
    }
    
    console.log(`Found ${rules.length} rules to update`);
    
    for (const rule of rules) {
      const updatedRule = await prisma.rule.upsert({
        where: {
          chapterId_number: {
            chapterId: chapter.id,
            number: rule.number
          }
        },
        update: {
          title: rule.title,
          content: rule.content,
          order: rule.order
        },
        create: {
          chapterId: chapter.id,
          number: rule.number,
          title: rule.title,
          content: rule.content,
          order: rule.order
        }
      });
      
      console.log(`Updated rule ${rule.number}: ${updatedRule.id}`);
    }
    
    console.log('All rules updated successfully');
    
  } catch (error) {
    console.error('Error updating rules:', error);
  } finally {
    await prisma.$disconnect();
  }
}

updateRules();